{"createdAt":"2025-10-05T16:20:40.398Z","updatedAt":"2025-10-05T16:22:14.576Z","id":"T4g4ItnBiHjv40qh","name":"inmobiliaria agente v2","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"d1668483-a991-4c52-a4ea-83bdc9defe05","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-9632,-320],"id":"19097962-eb00-4e32-8fba-1ca293cf8dc0","name":"Webhook","webhookId":"d1668483-a991-4c52-a4ea-83bdc9defe05","disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"90b09d00-02db-4c55-887a-15e3cba95e54","name":"input","value":"={{ $json.Texto }}","type":"string"},{"id":"0c756d81-6b26-46b7-9a81-210327795ead","name":"nombre","value":"={{ $json.Nombre }}","type":"string"},{"id":"807f90d6-26f1-404b-a3f8-5fbfda9ab852","name":"telefono","value":"={{ $('seteo inicial').item.json.telefono }}","type":"string"},{"id":"9ec855e8-4131-4ae1-8da0-675875bae85a","name":"id_mensaje","value":"={{ $('seteo inicial').item.json.message.id_session }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-8416,-304],"id":"2086f660-ca7b-488b-9f27-cf6f2e914683","name":"Input"},{"parameters":{"assignments":{"assignments":[{"id":"be8a1c63-ea52-4122-a74b-89a2fb18b51a","name":"Texto","value":"={{ $('seteo inicial').item.json.message.content }}","type":"string"},{"id":"f7410396-7182-4423-b28f-eff53ec5dca3","name":"Nombre","value":"={{ $('seteo inicial').item.json.user.name }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-8880,-560],"id":"7616d67a-cd48-424b-b149-03f16a22dcd4","name":"Texto"},{"parameters":{"assignments":{"assignments":[{"id":"ed053a66-3d19-4a4c-a79f-ecc1163c1eb7","name":"Texto","value":"={{ $json.text}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-8720,-144],"id":"ffa8f63c-582b-433b-9bda-791812d409a4","name":"Audio"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.message.content_type }}","rightValue":"text","operator":{"type":"string","operation":"equals"},"id":"8690e7b8-0407-48d6-8501-1e035192ef99"}],"combinator":"and"},"renameOutput":true,"outputKey":"text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ea6bf271-2d0a-4011-967d-67bb9ca9627f","leftValue":"={{ $json.message.content_type }}","rightValue":"audio","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-9296,-320],"id":"84a585a5-e759-4d8f-846d-e80ac021da3a","name":"Switch"},{"parameters":{"name":"buscar_disponibilidad","description":"Esta herramienta deber recibir las variables \"fechaReserva\" y \"horaReserva\" y obtendras si esta disponible la reserva y si no lo esta obtendras diferentes horas disponibles.","workflowId":{"__rl":true,"value":"FRZykpv6ktEHPEK4","mode":"list","cachedResultName":"ToolBuscarCita"},"workflowInputs":{"mappingMode":"defineBelow","value":{"fechaReserva":"={{ $fromAI(\"fechaReserva\") }}","horaReserva":"={{ $fromAI(\"horaReserva\") }}"},"matchingColumns":[],"schema":[{"id":"fechaReserva","displayName":"fechaReserva","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"horaReserva","displayName":"horaReserva","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[-6368,160],"id":"bbc82d70-2285-4210-a302-805d8b04b2f4","name":"Buscar Reserva","disabled":true},{"parameters":{"name":"reservar_pista","description":"Esta herramienta deber recibir las variables \"fechaReserva\" y \"horaReserva\" y reservara la pista al cliente.","workflowId":{"__rl":true,"value":"BNI5WNAOClkpJ1j5","mode":"list","cachedResultName":"ToolCrearCita"},"workflowInputs":{"mappingMode":"defineBelow","value":{"fechaReserva":"={{ $fromAI(\"fechaReserva\") }}","horaReserva":"={{ $fromAI(\"horaReserva\") }}","nombreReserva":"={{ $fromAI(\"nombreReserva\") }}"},"matchingColumns":[],"schema":[{"id":"fechaReserva","displayName":"fechaReserva","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"horaReserva","displayName":"horaReserva","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"nombreReserva","displayName":"nombreReserva","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[-6256,160],"id":"8159c8fa-9e72-454a-aaf3-01ef00287753","name":"Crear Reserva","disabled":true},{"parameters":{"options":{"systemMessage":"=# **Role**\nEres Pedro, te encargas de la atencion al cliente de la inmobiliaria \"Tu Hogar\".\nTienes más de 20 años de experiencia en la atencion al cliente y una tasa de acierto en tus respuestas del 99.8%.\nEres una pieza fundamental en la empresa, de ti dependen todas las consultas de los clientes y si haces bien tu trabajo podremos pagarte $2000.\nTen en cuenta que hoy es: **{{ $now.format('DDDD') }}**\n\n#Tarea\n- Tu tarea es detectar que es lo que el cliente necesita:\n 1. Buscar propiedades\n 2. Obtener detalles de una propiedad en especifico\n 3. Gestionar una consulta\n\n\n#Especificaciones\n\n## Especificaciones de la tarea 1\n\n  - Cuando el usuario quiera ver alguna de las propiedades que tengas tendras que valorar dos situaciones:\n\n    1. Si el cliente te menciona alguna característica, por ejemplo: \"¿Tienes algun piso en Barcelona por menos de 500 mil?\" o \"Estoy buscando algun chalet por sevilla\". Con las caracterisiticas que te ha dado el cliente llamaras a la herramienta **\"buscar_propiedades\"** y filtraras por las caracteristicas que te haya dicho. Si no encuentras exactamente lo que el te pide le recomendaras propiedades similares y si no encuentras similares le dirás que no tienes las propiedades que el busca.\n\n    2. Si el cliente no proporciona ninguna variable y solo quiere asesoramiento, por ejemplo: \"Buenas que propiedades tienes\" o \"Perdona, estoy buscando casa para alquilar\" hazle las siguientes preguntas una por una (es decir, hazle una pregunta, espera a que te responda, luego la otra, y asi sucesivamente) para definir mejor su búsqueda:\n\n  1. **\"¿Cuál es tu presupuesto aproximado para la compra o alquiler?\"**\n  2. **\"¿En qué zona o ciudad te gustaría encontrar el inmueble?\"**\n  3. **\"¿Cuántas habitaciones necesitas?\"**\n  4. **\"¿Prefieres un piso, una casa o estás abierto a opciones?\"**\n\n**IMPORTANTE: No repitas la respuesta que dió el lead a la anterior pregunta cuando le hagas la siguiente pregunta**. Sencillamente avanza con la siguiente pregunta.\nPor ejemplo, si el lead contestó \"Mi presupuesto es de 120 a 180 mil\", **NO DIGAS**: \"Vale tu presupuesto es de 120 a 180 mil, ¿qué zona o ciudad te gustaría encontrar el inmueble?\"\n\"En su lugar, el mensaje correcto sería algo como \"Bien, ¿qué zona o ciudad te gustaría encontrar el inmueble?\" o \"Perfecto, vamos con la siguiente\".\n- Si el cliente no quiere proporcionarte alguna caracteristica o le da igual, entonces en ese caso podras rellenar ese campo tu como mejor consideres.\n\nUna vez que el cliente haya terminado de contestar todas las preguntas, **llama a la herramienta \"buscar_propiedades\"**.\n\nY le enviaras las propiedades de la forma más clara y limpia posible, con las características de cada propiedad en un formato de lista de puntos.\nY le preguntarás si quiere más información sobre alguno de las propiedades.\n\n## Especificaciones de la tarea 2\n\n### Instrucciones\nSi el cliente te dice que quiere obtener mas información de alguna propiedad en concreto por ejemplo: \"Me ha gustado la 2 que me has enseñado, me puedes dar mas información\", iras al \"Window Buffer Memory\" para obtener los id de las propiedades que le has mostrado anteriormente y obtendras el id de esa propiedad que el usuario te indica y llamarás a la herramienta **buscar_informacion** y le darás el id de esa propiedad.\n\n## Especificaciones de la tarea 3\n\n### Instrucciones\nSi al cliente le gusta algún inmueble **deberás proceder con la reserva de una reunión**, pregúntale, un día y una hora que le venga bien (en caso de que no te lo haya dicho ya) si el cliente te dice una fecha relativa deberás calcular que fecha es para convertirla en el formato \"YYYY-MM-DD\" teniendo en cuenta que la fecha de hoy es: {{ $now.format('DDDD') }} y guardaras la fecha en la variable {{ \"fechaReserva\" }} \n\n  - Una vez obtengas la fecha y la hora **llamarás a la herramienta \"buscar_reserva\"**, la misma te responderá si la fecha esta disponible y si no te devolverá varias horas disponibles ese mismo día.\n\n  - Una vez hayais confirmado una fecha y hora exacta deberás pedirle su nombre y apellidos (si no te lo ha dicho ya) y su correo, cuando los tengas **llamarás a la herramienta \"reservar_reunion\"** con la fecha formateada, la hora, el nombre y correo.\n\nCuando hayas terminado le preguntarás si necesita algo más y si no le darás las gracias y que le esperas allí a la fecha que habeís acordado."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.7,"position":[-6080,-512],"id":"128d172b-a49b-4212-b742-a9b3d404fa7c","name":"AI Agent1"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Supabase1').item.json.session_id }}"},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[-6992,336],"id":"95d020d9-c888-48e6-8159-3c9a9deff405","name":"Window Buffer Memory1"},{"parameters":{"promptType":"define","text":"={{ $json.output }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"=# Adapta la respuesta \"{{ $json.output }}\" de acuerdo a las siguientes intrucciones:\n\n- Elimina estos caractéres:\n  ·\"*\", \"¿\", \"¡\", \"#\"\n- Mantén los saltos de línea **cuando corresponda**, principalmente en los listados o Bullet Points Lists. \n- Utiliza signos de interrogación \"?\" **solo en el final de las frases.**\n- El mensaje debe sonar relajado formal y respetuaoso.\n- Si la respuesta es breve, rellena únicamente la parte1.\n- Si la respuesta es más extensa, considera rellenar la parte2 y la parte3\n- Si el mensaje contiene una lista, déjala sola en una parte, **manteniendo el formato de lista** (con los saltos de línea correspondientes).\n- **El output debe sonar muy natural y humano. Debes eliminar las siguientes frases o similares:\n  - \"Estoy aquí para ayudarte\"\n  - \"Estaré encantado de ayudarte\"\n  - \"Gracias por la información\"\n  - \"No dudes en preguntar\"\n  - \"Con gusto te ayudaré\".**\n- **La respuesta final debe ser lo más similar posible a la respuesta inicial, no cambies radicalmente las palabras o el significado de la respuesta inicial si no es necesario**."}]}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.5,"position":[-5056,-512],"id":"22966703-2039-486d-8572-f0791f438c01","name":"Generador de respuestas","retryOnFail":false},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.outputParserAutofixing","typeVersion":1,"position":[-4976,-208],"id":"7755b8d2-be8a-402a-8490-8c69a985565b","name":"Auto-fixing Output Parser"},{"parameters":{"jsonSchemaExample":"{\n  \"response\": {\n    \"parte1\": \"Parte uno de la respuesta\",\n    \"parte2\": \"Parte dos de la respuesta\", \n    \"parte3\": \"Parte tres de la respuesta (opcional).\"\n  }\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[-4832,16],"id":"ede01329-b44a-46a4-b8dc-447ecb3c9ff5","name":"Structured Output Parser"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-4128,-512],"id":"a875be64-b800-46da-92d9-2450189409cd","name":"Wait1","webhookId":"46932fea-1310-433e-a1ac-ddf097bbe5e8"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-3680,16],"id":"0f658007-0b88-43a9-a278-5b294421c187","name":"No Operation, do nothing1"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-3888,-272],"id":"c6d12b73-55df-4efd-9844-0c2c00417c26","name":"Wait2","webhookId":"2abbf3be-e618-4e9a-b282-67751468f3b1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"882db3de-7e7d-4560-806f-310f5a30b3a3","leftValue":"={{ $('Generador de respuestas').item.json.output.response.parte2 }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4416,-352],"id":"f462134f-c36e-47c5-8212-a8a338078d19","name":"If Parte 2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4a3c8735-87ee-4888-9ec6-4704b572eb6f","leftValue":"={{ $('Generador de respuestas').item.json.output.response.parte3 }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-4112,-128],"id":"19330e68-7b2e-464b-b069-eedf343f903a","name":"If Parte 3"},{"parameters":{"name":"buscar_propiedades","description":"=# Ejecuta esta herramienta con todos los datos que hayas obtenido del usuario.","workflowId":{"__rl":true,"value":"5aQm4Y9gDUm8KNtf","mode":"list","cachedResultName":"Inmobiliaria | Buscar Inmueble"},"workflowInputs":{"mappingMode":"defineBelow","value":{"numHabitaciones":"={{ $fromAI(\"numHabitaciones\") }}","precioExacto":"={{ $fromAI(\"precioExacto\") }}","precioMin":"={{ $fromAI(\"precioMin\") }}","precioMax":"={{ $fromAI(\"precioMax\") }}","ubicacion":"={{ $fromAI(\"ubicacion\") }}","tipoInmueble":"={{ $fromAI(\"tipoInmueble\") }}"},"matchingColumns":[],"schema":[{"id":"precioExacto","displayName":"precioExacto","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"precioMin","displayName":"precioMin","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"precioMax","displayName":"precioMax","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"ubicacion","displayName":"ubicacion","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"numHabitaciones","displayName":"numHabitaciones","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number"},{"id":"tipoInmueble","displayName":"tipoInmueble","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[-6512,160],"id":"e501e18a-4e4c-4e63-94b0-d24db1c1414f","name":"Buscar Propiedades","disabled":true},{"parameters":{"name":"buscar_informacion","description":"Llamarás a esta herramienta cuando el cliente te pida mas informacion sobre alguno de los inmuebles que le has proporcionado para poder obtener mas informacion","workflowId":{"__rl":true,"value":"5vVYXz3GPjfDc1KX","mode":"list","cachedResultName":"Inmobiliaria | Buscar Informacion"},"workflowInputs":{"mappingMode":"defineBelow","value":{"id":"={{ $fromAI(\"Id\") }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"number","removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[-6128,160],"id":"a2b1df59-647a-4a9a-935e-bb0841327066","name":"Buscar Informacion","disabled":true},{"parameters":{"content":"## Encolado de mensajes\n","height":860,"width":1600,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-8192,-624],"typeVersion":1,"id":"d4a6520d-e6a6-4981-bd01-8b6230a0014d","name":"Sticky Note"},{"parameters":{"content":"## Recibe mensaje de Whatsapp\n","height":860,"width":1440},"type":"n8n-nodes-base.stickyNote","position":[-9648,-624],"typeVersion":1,"id":"7ddb7096-64be-4726-abc3-77fad9c68517","name":"Sticky Note1"},{"parameters":{"assignments":{"assignments":[{"id":"e3d8e45d-6ec7-40c7-8ad0-cf6822baaf0b","name":"instance.server_url","value":"={{ $json.body.server_url }}","type":"string"},{"id":"c94fd657-20eb-4d75-87c1-9aad99dd8068","name":"instance.nombre","value":"={{ $json.body.instance }}","type":"string"},{"id":"af61c2a0-54a0-4a34-b6eb-9ccbfadda86b","name":"instance.apikey","value":"={{ $json.body.apikey }}","type":"string"},{"id":"ffc263bd-0a90-4f50-84f1-e3f87474eb01","name":"message.id_user","value":"={{ $json.body.data.key.remoteJid }}","type":"string"},{"id":"65c29034-84d4-4168-bbf0-267b0553d7d3","name":"message.id_session","value":"={{ $json.body.data.key.id }}","type":"string"},{"id":"9f458742-29f6-4ff8-b54d-537e3bd5bef0","name":"message.content_type","value":"={{ $json.body.data.message.extendedTextMessage ? 'text': '' }}{{ $json.body.data.message.conversation ? 'text': '' }}{{ $json.body.data.message.audioMessage ? 'audio': '' }}{{ $json.body.data.message.imageMessage ? 'image': '' }}","type":"string"},{"id":"2b442264-0eb6-4cb2-ab60-7e7953ddc67c","name":"message.content","value":"={{ $json.body.data.message.extendedTextMessage?.text || '' }}{{ $json.body.data.message.imageMessage?.caption || '' }}{{ $json.body.data.message.conversation || '' }}","type":"string"},{"id":"25250918-29b3-4e28-9b97-dd589825dc4e","name":"message.date","value":"={{ $json.body.date_time.toDateTime().toISO() }}","type":"string"},{"id":"ca801f80-75f8-4c0a-be9b-af56dd61f65a","name":"user.name","value":"={{ $json.body.data.pushName }}","type":"string"},{"id":"9bc1e058-2a3f-4bc2-af42-20f2839e258c","name":"keyapi.llamacloud","value":"llx-G4nIoLF8GTb6Cz5lYshItVBld2CGvB3k1rbJkYSCiOQuDI7V","type":"string"},{"id":"558b0df5-2ebf-4559-abd6-5c734334733d","name":"telefono","value":"={{ $json.body.data.key.remoteJid.split('@').first() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-9456,-320],"id":"48cbd5ff-1a9b-4ac3-a2cd-6003d2843290","name":"seteo inicial"},{"parameters":{"method":"POST","url":"https://api.groq.com/openai/v1/audio/transcriptions","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"bearer "}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"model","value":"whisper-large-v3-turbo"},{"name":"temperature","value":"0"},{"name":"response_format","value":"verbose_json"},{"name":"language","value":"es"},{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"data"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-8912,-144],"id":"8cc35f89-4930-412e-946d-28d531e9366c","name":"groq transcripción"},{"parameters":{"resource":"chat-api","operation":"get-media-base64","instanceName":"={{ $('seteo inicial').item.json.instance.nombre }}","messageId":"={{ $('seteo inicial').item.json.message.id_session }}","convertToMp4":true},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-9328,-64],"id":"02fa2b26-61f2-4aff-9f82-359f359b2588","name":"descarga audio"},{"parameters":{"operation":"toBinary","sourceProperty":"data.base64","options":{}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[-9152,-64],"id":"d5d8949a-ed39-4168-bad8-10f387e84a09","name":"Convertir base64 a audio."},{"parameters":{"operation":"select","schema":{"__rl":true,"value":"public","mode":"list","cachedResultName":"public"},"table":{"__rl":true,"value":"n8n_fila_mensajes","mode":"list","cachedResultName":"n8n_fila_mensajes"},"limit":1,"where":{"values":[{"column":"telefono","value":"={{ $json.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-8096,-304],"id":"657977e9-0b56-45f0-9bc1-44bb0cec47cd","name":"Postgres","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"890eb9cb-2fc3-4a87-a1ab-94eaa963ba90","leftValue":"={{ $json.mensaje }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-7920,-304],"id":"cf2e0353-c595-40ba-9ece-896e418a9e2c","name":"tiene conversación?"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_fila_mensajes","mode":"list","cachedResultName":"n8n_fila_mensajes"},"columns":{"mappingMode":"defineBelow","value":{"mensaje":"={{ $('Postgres').item.json.mensaje }}/{{ $('Input').item.json.input }}","telefono":"={{ $('Input').item.json.telefono }}"},"matchingColumns":["telefono"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"id_mensaje","displayName":"id_mensaje","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"telefono","displayName":"telefono","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"mensaje","displayName":"mensaje","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"fecha_hora","displayName":"fecha_hora","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-7696,-400],"id":"715154eb-b8e7-422b-91c3-50b26af7f0e8","name":"Postgres1","retryOnFail":true},{"parameters":{"amount":15},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-7456,-400],"id":"0e27ad15-45b9-49d6-aff2-fbfec18f9037","name":"Wait4","webhookId":"d7138527-3906-49ae-9808-c35120116a21"},{"parameters":{"amount":15},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-7456,-208],"id":"5d03e591-71e0-460a-8415-f33a2a744b15","name":"Wait5","webhookId":"f57a6a5c-2813-488b-902f-058ee0f4b9c2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b26f51fc-a585-4854-868a-8e9efc0fe1d8","leftValue":"={{ $json.mensaje.split('/').pop() }}","rightValue":"={{ $('Input').item.json.input }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-6992,-224],"id":"103951d0-97f1-44f1-83c2-0401866646a1","name":"If2"},{"parameters":{"assignments":{"assignments":[{"id":"ee0be3d6-83b5-4fdd-aecb-0503e4f4d7e3","name":"mensaje_final","value":"={{ $('recupera').item.json.mensaje.replace('/',' ') }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-6992,-400],"id":"edf27497-b38d-4dd0-8fbe-c5029656c19d","name":"Edit Fields"},{"parameters":{"modelName":"models/gemini-2.0-flash-exp","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-6240,-288],"id":"b0a7bd9c-0320-4eea-9d9a-eec16afba1b7","name":"Google Gemini Chat Model"},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolThink","typeVersion":1,"position":[-5520,-272],"id":"cec4faf6-183c-43c8-bbe9-81cc877716da","name":"Think"},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_fila_mensajes","mode":"list","cachedResultName":"n8n_fila_mensajes"},"deleteCommand":"delete","where":{"values":[{"column":"telefono","value":"={{ $('If2').item.json.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-6752,-400],"id":"a7c80b45-6d1b-4e12-a739-a4821a9ef6fb","name":"elimina cola"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_fila_mensajes","mode":"list","cachedResultName":"n8n_fila_mensajes"},"columns":{"mappingMode":"defineBelow","value":{"id":0,"id_mensaje":"={{ $('seteo inicial').item.json.message.id_session }}","telefono":"={{ $('seteo inicial').item.json.telefono }}","mensaje":"={{ $('seteo inicial').item.json.message.content }}","fecha_hora":"={{ $('seteo inicial').item.json.message.date }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"id_mensaje","displayName":"id_mensaje","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"telefono","displayName":"telefono","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"mensaje","displayName":"mensaje","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"fecha_hora","displayName":"fecha_hora","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-7696,-208],"id":"1f598fb6-e233-4aa7-a3af-169bb898c5dc","name":"crea","retryOnFail":true},{"parameters":{"operation":"select","schema":{"__rl":true,"value":"public","mode":"list","cachedResultName":"public"},"table":{"__rl":true,"value":"n8n_fila_mensajes","mode":"list","cachedResultName":"n8n_fila_mensajes"},"limit":1,"where":{"values":[{"column":"telefono","value":"={{ $json.telefono }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-7216,-304],"id":"4d932db2-158f-4e4f-a266-3a37e4a7db7a","name":"recupera","alwaysOutputData":true,"retryOnFail":true},{"parameters":{"modelName":"models/gemini-2.0-flash-lite","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[-5136,16],"id":"0f44639b-149a-4592-ba7a-4e58c863e05b","name":"Google Gemini Chat Model1"},{"parameters":{"sessionIdType":"customKey","sessionKey":"=51952373850"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[-6080,-288],"id":"2af4ed9c-d234-4c9e-9c37-82fac135ebdd","name":"Postgres Chat Memory"},{"parameters":{"resource":"messages-api","instanceName":"={{ $('seteo inicial').item.json.instance.nombre }}","remoteJid":"={{ $('seteo inicial').item.json.telefono }}","messageText":"={{ $('Generador de respuestas').item.json.output.response.parte1 }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-4416,-560],"id":"e5b42900-19e5-4dd0-b662-4843c5b983d7","name":"Responder parte1"},{"parameters":{"resource":"messages-api","instanceName":"={{ $('seteo inicial').item.json.instance.nombre }}","remoteJid":"={{ $('seteo inicial').item.json.telefono }}","messageText":"={{ $('Generador de respuestas').item.json.output.response.parte2 }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-3952,-512],"id":"47f9c90f-3d38-4fe7-83ba-af00f414f947","name":"Responder parte2"},{"parameters":{"resource":"messages-api","instanceName":"={{ $('seteo inicial').item.json.instance.nombre }}","remoteJid":"={{ $('seteo inicial').item.json.telefono }}","messageText":"={{ $('Generador de respuestas').item.json.output.response.parte3 }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-3696,-272],"id":"3240f8fe-30cb-453e-bc7a-042f7958e53b","name":"Responder parte3"},{"parameters":{"content":"## Dividir respuesta\n","height":860,"width":1820,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-5232,-624],"typeVersion":1,"id":"9569ed96-a277-474c-9505-2a7ea9590633","name":"Sticky Note2"},{"parameters":{"authentication":"nocoDbApiToken","workspaceId":"wc9xslxo","projectId":"pedqg1800wrc246","table":"mqimz04t9flld6x","id":"1"},"type":"n8n-nodes-base.nocoDb","typeVersion":3,"position":[-5152,-880],"id":"b729a581-8c2b-421b-87d5-3914932dc2ef","name":"NocoDB"},{"parameters":{"url":"={{ $json.archivo[0].signedUrl }}","sendQuery":true,"queryParameters":{"parameters":[{"name":"X-Amz-Algorithm","value":"..."}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"accept","value":"application/pdf"}]},"sendBody":true,"contentType":"raw","rawContentType":"={{ $json.archivo[0].mimetype }}","options":{"response":{"response":{"responseFormat":"file","outputPropertyName":"={{ $json.archivo[0].title }}"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-4992,-880],"id":"05b951c3-e87f-4865-be92-c38f64edd6bc","name":"HTTP Request"},{"parameters":{"content":"## enviar brochure\nDescargamos desde la ruta del contenedor S3","height":340,"width":800,"color":7},"type":"n8n-nodes-base.stickyNote","position":[-5216,-992],"typeVersion":1,"id":"a74d5bba-3792-4087-b971-afebbe4199ef","name":"Sticky Note3"},{"parameters":{"resource":"messages-api","operation":"send-document","instanceName":"={{ $('seteo inicial').item.json.instance.nombre }}","remoteJid":"={{ $('seteo inicial').item.json.telefono }}","media":"={{ $json.data }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[-4656,-880],"id":"533c55af-986a-4776-8f9d-bcd12d8d79cd","name":"Responder parte"},{"parameters":{"operation":"binaryToPropery","binaryPropertyName":"brochere-living-tower.pdf","options":{}},"type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[-4832,-880],"id":"fb0903a6-065d-408b-ba90-cacccc4e36ed","name":"Extract from File"},{"parameters":{"content":"## AGENTE\n","height":540,"width":1320,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-6576,-624],"typeVersion":1,"id":"9e50bc31-030a-42f8-8884-42f45eb2d7d6","name":"Sticky Note4"},{"parameters":{"content":"## Tools \n","height":300,"width":760,"color":6},"type":"n8n-nodes-base.stickyNote","position":[-6016,-64],"typeVersion":1,"id":"4518be84-37e4-4af3-aae1-5024ac304e35","name":"Sticky Note5"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.1,"position":[-6512,-512],"id":"56d26990-c829-4bfa-9868-5b1f82d6d258","name":"When chat message received","webhookId":"fe367405-376b-4bc1-8ae2-09140ed6c26c"},{"parameters":{"descriptionType":"manual","toolDescription":"# Ejecuta esta herramienta con todos los datos que hayas obtenido del usuario.","authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wc9xslxo","projectId":"pedqg1800wrc246","table":"mynh492xpckrke7","returnAll":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', ``, 'boolean') }}","options":{}},"type":"n8n-nodes-base.nocoDbTool","typeVersion":3,"position":[-5920,-288],"id":"ab43b4d3-2be5-4020-b2f6-1a1b9aaac84d","name":"Buscar propiedades"},{"parameters":{"descriptionType":"manual","toolDescription":"# Ejecuta esta herramienta con todos los datos que hayas obtenido del usuario.","authentication":"nocoDbApiToken","operation":"getAll","workspaceId":"wc9xslxo","projectId":"pedqg1800wrc246","table":"mynh492xpckrke7","returnAll":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', ``, 'boolean') }}","options":{}},"type":"n8n-nodes-base.nocoDbTool","typeVersion":3,"position":[-5760,-272],"id":"f0794a2c-8e5e-426b-a46f-a1f04ad726e2","name":"preguntas frecuentes"},{"parameters":{},"type":"n8n-nodes-message-buffer.messageBuffer","typeVersion":1,"position":[-7808,-16],"id":"b6bc1e57-6551-497d-baa1-eb6eae465a2e","name":"Message Buffer","credentials":{"redis":{"id":"80fx3lEFucW5yx3K","name":"Redis account cloud"}}}],"connections":{"Webhook":{"main":[[{"node":"seteo inicial","type":"main","index":0}]]},"Input":{"main":[[{"node":"Postgres","type":"main","index":0},{"node":"Message Buffer","type":"main","index":0}]]},"Texto":{"main":[[{"node":"Input","type":"main","index":0}]]},"Audio":{"main":[[{"node":"Input","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Texto","type":"main","index":0}],[{"node":"descarga audio","type":"main","index":0}]]},"Generador de respuestas":{"main":[[{"node":"Responder parte1","type":"main","index":0}]]},"Auto-fixing Output Parser":{"ai_outputParser":[[{"node":"Generador de respuestas","type":"ai_outputParser","index":0}]]},"Structured Output Parser":{"ai_outputParser":[[{"node":"Auto-fixing Output Parser","type":"ai_outputParser","index":0}]]},"Wait1":{"main":[[{"node":"Responder parte2","type":"main","index":0}]]},"Wait2":{"main":[[{"node":"Responder parte3","type":"main","index":0}]]},"If Parte 2":{"main":[[{"node":"Wait1","type":"main","index":0}],[{"node":"If Parte 3","type":"main","index":0}]]},"If Parte 3":{"main":[[{"node":"Wait2","type":"main","index":0}],[{"node":"No Operation, do nothing1","type":"main","index":0}]]},"seteo inicial":{"main":[[{"node":"Switch","type":"main","index":0}]]},"groq transcripción":{"main":[[{"node":"Audio","type":"main","index":0}]]},"descarga audio":{"main":[[{"node":"Convertir base64 a audio.","type":"main","index":0}]]},"Convertir base64 a audio.":{"main":[[{"node":"groq transcripción","type":"main","index":0}]]},"Postgres":{"main":[[{"node":"tiene conversación?","type":"main","index":0}]]},"tiene conversación?":{"main":[[{"node":"Postgres1","type":"main","index":0}],[{"node":"crea","type":"main","index":0}]]},"Postgres1":{"main":[[{"node":"Wait4","type":"main","index":0}]]},"Wait4":{"main":[[{"node":"recupera","type":"main","index":0}]]},"Wait5":{"main":[[{"node":"recupera","type":"main","index":0}]]},"If2":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"elimina cola","type":"main","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Think":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"crea":{"main":[[{"node":"Wait5","type":"main","index":0}]]},"recupera":{"main":[[{"node":"If2","type":"main","index":0}]]},"Google Gemini Chat Model1":{"ai_languageModel":[[{"node":"Generador de respuestas","type":"ai_languageModel","index":0},{"node":"Auto-fixing Output Parser","type":"ai_languageModel","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI Agent1","type":"ai_memory","index":0}]]},"Responder parte1":{"main":[[{"node":"If Parte 2","type":"main","index":0}]]},"Responder parte2":{"main":[[{"node":"If Parte 3","type":"main","index":0}]]},"Responder parte3":{"main":[[{"node":"No Operation, do nothing1","type":"main","index":0}]]},"NocoDB":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Extract from File","type":"main","index":0}]]},"Extract from File":{"main":[[{"node":"Responder parte","type":"main","index":0}]]},"When chat message received":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"Buscar propiedades":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"preguntas frecuentes":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"ene8w.eficiencia.cloud","user-agent":"axios/1.7.9","content-length":"926","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"172.18.0.1","x-forwarded-host":"ene8w.eficiencia.cloud","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"444459aaaa5f","x-real-ip":"172.18.0.1"},"params":{},"query":{},"body":{"event":"messages.upsert","instance":"reservas","data":{"key":{"remoteJid":"51952373850@s.whatsapp.net","fromMe":false,"id":"3F051893EE82B713F1E0"},"pushName":"Jesus Arenas","status":"DELIVERY_ACK","message":{"messageContextInfo":{"deviceListMetadata":{"senderKeyHash":"7WgVf7S4ECXZZQ==","senderTimestamp":"1748354136","recipientKeyHash":"3fAiBoqZKz3qpw==","recipientTimestamp":"1748468737"},"deviceListMetadataVersion":2},"conversation":"hola"},"contextInfo":{"expiration":0,"ephemeralSettingTimestamp":"0","disappearingMode":{"initiator":"CHANGED_IN_CHAT"}},"messageType":"conversation","messageTimestamp":1748560000,"instanceId":"5b35680b-73e8-4531-9774-e678d59cf0f9","source":"unknown"},"destination":"https://ene8w.eficiencia.cloud/webhook/secretarIA","date_time":"2025-05-29T20:06:40.443Z","sender":"51917381920@s.whatsapp.net","server_url":"https://evo.eficiencia.cloud","apikey":"E4087C7F5485-43AA-BEAD-32E52988914D"},"webhookUrl":"https://ene8w.eficiencia.cloud/webhook/secretarIA","executionMode":"production"}}],"Edit Fields":[{"json":{"mensaje_final":"hola hola, quiero informacion"}}],"NocoDB":[{"json":{"Id":1,"CreatedAt":"2025-06-04 15:35:10+00:00","UpdatedAt":"2025-06-06 18:30:02+00:00","titulo":"QUATRO INMOBILIARIA","archivo":[{"url":"https://nocohub-001-prod-app-attachments.s3.us-east-2.amazonaws.com/nc/uploads/2025/06/06/62fbd8290ce7228bf63bffce47c09383b3faed46/brochere-living-tower_C9UdW.pdf","title":"brochere-living-tower.pdf","mimetype":"application/pdf","size":3789381,"icon":"mdi-pdf-box","id":"atzy986pzhafwh48","thumbnails":{"tiny":{"signedUrl":"https://nocohub-001-prod-app-attachments.s3.us-east-2.amazonaws.com/nc/thumbnails/2025/06/06/62fbd8290ce7228bf63bffce47c09383b3faed46/brochere-living-tower_C9UdW.pdf/tiny.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIATUJCOBWTKOMQ5JMU%2F20250607%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Date=20250607T173629Z&X-Amz-Expires=7411&X-Amz-Signature=891807159efee5a50880e47a8f1db44df66ad2e2901bff0247c5ce94a8f70ba1&X-Amz-SignedHeaders=host&response-content-disposition=inline%3B%20filename%3D%22brochere-living-tower.pdf%22&response-content-type=image%2Fjpeg&x-amz-checksum-mode=ENABLED&x-id=GetObject"},"small":{"signedUrl":"https://nocohub-001-prod-app-attachments.s3.us-east-2.amazonaws.com/nc/thumbnails/2025/06/06/62fbd8290ce7228bf63bffce47c09383b3faed46/brochere-living-tower_C9UdW.pdf/small.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIATUJCOBWTKOMQ5JMU%2F20250607%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Date=20250607T173629Z&X-Amz-Expires=7411&X-Amz-Signature=b6539e28bb335b685b5524753b8d6bc2d3b7abda867f78ec3a9bf1ef77bcde03&X-Amz-SignedHeaders=host&response-content-disposition=inline%3B%20filename%3D%22brochere-living-tower.pdf%22&response-content-type=image%2Fjpeg&x-amz-checksum-mode=ENABLED&x-id=GetObject"},"card_cover":{"signedUrl":"https://nocohub-001-prod-app-attachments.s3.us-east-2.amazonaws.com/nc/thumbnails/2025/06/06/62fbd8290ce7228bf63bffce47c09383b3faed46/brochere-living-tower_C9UdW.pdf/card_cover.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIATUJCOBWTKOMQ5JMU%2F20250607%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Date=20250607T173629Z&X-Amz-Expires=7411&X-Amz-Signature=9bf02a65b7b2339487f49c6690e966fad7a0d382deb22ed81e69fb9c81589104&X-Amz-SignedHeaders=host&response-content-disposition=inline%3B%20filename%3D%22brochere-living-tower.pdf%22&response-content-type=image%2Fjpeg&x-amz-checksum-mode=ENABLED&x-id=GetObject"}},"signedUrl":"https://nocohub-001-prod-app-attachments.s3.us-east-2.amazonaws.com/nc/uploads/2025/06/06/62fbd8290ce7228bf63bffce47c09383b3faed46/brochere-living-tower_C9UdW.pdf?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIATUJCOBWTKOMQ5JMU%2F20250607%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Date=20250607T173629Z&X-Amz-Expires=7411&X-Amz-Signature=fd6943e2f5aef56367445af320dfe9674179e66033ca3abadb82996bb7f6e6af&X-Amz-SignedHeaders=host&response-content-disposition=inline%3B%20filename%3D%22brochere-living-tower.pdf%22&response-content-type=application%2Fpdf&x-amz-checksum-mode=ENABLED&x-id=GetObject"}],"IDENTIFICADOR":1}}]},"versionId":"deb0898b-e998-4204-8683-cda13248bc7c","triggerCount":0,"shared":[{"createdAt":"2025-10-05T16:20:40.398Z","updatedAt":"2025-10-05T16:20:40.398Z","role":"workflow:owner","workflowId":"T4g4ItnBiHjv40qh","projectId":"SqMi70IbghSQH4eu"}],"tags":[]}